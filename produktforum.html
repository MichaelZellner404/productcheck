<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProduktForum</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap');

        [data-theme="dark"] {
            --bg:#050505; --bg2:#111; --card:#1a1a1a; --border:#252525; --border2:#333;
            --text:#f0f0eb; --muted:#777; --muted2:#444; --green:#00ff88; --red:#ff2244;
            --overlay:rgba(0,0,0,0.92); --shadow:0 16px 48px rgba(0,0,0,0.7); --input-bg:#0a0a0a;
        }
        [data-theme="light"] {
            --bg:#f2f1ed; --bg2:#e8e7e3; --card:#ffffff; --border:#ddd; --border2:#ccc;
            --text:#111111; --muted:#777; --muted2:#bbb; --green:#00994d; --red:#cc0022;
            --overlay:rgba(0,0,0,0.7); --shadow:0 16px 48px rgba(0,0,0,0.15); --input-bg:#f9f9f7;
        }

        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .25s,color .25s;}

        /* HEADER */
        header{background:var(--bg);border-bottom:1px solid var(--border);padding:16px 0;position:sticky;top:0;z-index:900;}
        .header-content{max-width:1400px;margin:0 auto;padding:0 24px;display:flex;justify-content:space-between;align-items:center;}
        .logo{font-family:'Bebas Neue',sans-serif;font-size:2em;letter-spacing:4px;}
        .logo span{color:var(--green);}
        .header-right{display:flex;gap:10px;align-items:center;}
        .user-chip{display:none;align-items:center;gap:8px;padding:6px 14px;border:1px solid var(--border2);background:var(--card);font-family:'Space Mono',monospace;font-size:.75em;cursor:pointer;transition:all .2s;}
        .user-chip.active{display:flex;}
        .user-chip:hover{border-color:var(--text);}
        .user-avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9em;font-weight:700;}
        .admin-badge{background:var(--red);color:#fff;padding:4px 12px;font-family:'Space Mono',monospace;font-size:.72em;letter-spacing:2px;display:none;}
        .admin-badge.active{display:block;}

        /* BUTTONS */
        .btn{padding:9px 20px;border:1px solid var(--text);background:transparent;color:var(--text);font-family:'Space Mono',monospace;font-size:.78em;letter-spacing:1px;cursor:pointer;transition:all .2s;text-transform:uppercase;white-space:nowrap;}
        .btn:hover{background:var(--text);color:var(--bg);}
        .btn-green{border-color:var(--green);color:var(--green);}
        .btn-green:hover{background:var(--green);color:var(--bg);}
        .btn-red{border-color:var(--red);color:var(--red);}
        .btn-red:hover{background:var(--red);color:#fff;}
        .btn-solid{background:var(--text);color:var(--bg);}
        .btn-solid:hover{background:transparent;color:var(--text);}
        .btn-sm{padding:5px 12px;font-size:.72em;}

        /* SETTINGS OVERLAY */
        .settings-overlay{display:none;position:fixed;inset:0;background:var(--overlay);z-index:3000;align-items:flex-start;justify-content:flex-end;padding:20px;}
        .settings-overlay.active{display:flex;}
        .settings-panel{background:var(--card);border:1px solid var(--border2);width:420px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);margin-top:60px;}
        .settings-header{padding:22px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
        .settings-header h2{font-family:'Bebas Neue',sans-serif;font-size:1.5em;letter-spacing:3px;}
        .settings-section{padding:20px 24px;border-bottom:1px solid var(--border);}
        .settings-section-title{font-family:'Space Mono',monospace;font-size:.7em;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:14px;}
        .toggle-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
        .toggle-label{font-size:.9em;}
        .toggle{position:relative;width:44px;height:24px;background:var(--border2);border-radius:12px;cursor:pointer;transition:background .2s;}
        .toggle.on{background:var(--green);}
        .toggle::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:3px;left:3px;transition:left .2s;}
        .toggle.on::after{left:23px;}
        .account-loggedin{display:none;}
        .account-loggedin.active{display:block;}
        .account-loggedout.hidden{display:none;}
        .account-info-box{background:var(--bg2);border:1px solid var(--border);padding:14px;margin-bottom:14px;}
        .account-username{font-family:'Bebas Neue',sans-serif;font-size:1.3em;letter-spacing:2px;margin-bottom:4px;}
        .account-stats{font-size:.8em;color:var(--muted);font-family:'Space Mono',monospace;}
        .admin-loggedin{display:none;align-items:center;gap:10px;}
        .admin-loggedin.active{display:flex;}
        .admin-status-dot{width:8px;height:8px;border-radius:50%;background:var(--red);animation:pulse 1.5s ease-in-out infinite;}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
        .user-level{display:inline-block;background:var(--green);color:var(--bg);padding:2px 8px;font-size:.7em;font-family:'Space Mono',monospace;margin-left:8px;}
        .user-badges{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
        .badge{padding:3px 8px;font-size:.7em;border:1px solid var(--border2);font-family:'Space Mono',monospace;}
        .sync-status{font-size:.75em;color:var(--muted2);font-family:'Space Mono',monospace;margin-top:10px;display:flex;align-items:center;gap:6px;}
        .sync-indicator{width:6px;height:6px;border-radius:50%;background:var(--green);}

        /* MAIN */
        .container{max-width:1400px;margin:0 auto;padding:28px 24px;}

        /* UPLOAD/SCANNER/FORM */
        .upload-section{background:var(--card);border:1px solid var(--border2);padding:36px;margin-bottom:32px;display:none;}
        .section-title{font-family:'Bebas Neue',sans-serif;font-size:1.5em;letter-spacing:3px;margin-bottom:18px;border-bottom:1px solid var(--border);padding-bottom:10px;}
        .upload-area{border:2px dashed var(--border2);padding:56px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg);}
        .upload-area:hover,.upload-area.dragover{border-color:var(--green);box-shadow:0 0 30px rgba(0,200,100,.07);}
        .upload-icon{font-size:3em;margin-bottom:12px;}
        .upload-text{font-family:'Space Mono',monospace;font-size:.95em;letter-spacing:1px;margin-bottom:6px;}
        .upload-subtext{color:var(--muted);font-size:.85em;}
        input[type="file"]{display:none;}
        .scanner-container{display:none;background:var(--card);border:1px solid var(--border2);padding:36px;margin-bottom:32px;}
        .scanner-status{text-align:center;margin-top:18px;font-family:'Space Mono',monospace;font-size:.85em;}
        .barcode-result{background:var(--bg);border:1px solid var(--green);padding:18px;margin-top:18px;text-align:center;}
        .barcode-number{font-family:'Space Mono',monospace;font-size:1.6em;color:var(--green);letter-spacing:4px;}
        .lookup-status{background:var(--bg);border:1px solid var(--border);padding:20px;margin-top:18px;display:none;}
        .lookup-step{display:flex;align-items:center;gap:10px;padding:7px 0;font-family:'Space Mono',monospace;font-size:.82em;color:var(--muted);transition:color .3s;}
        .lookup-step.active{color:var(--text);}
        .lookup-step.done{color:var(--green);}
        .lookup-step.error{color:var(--red);}
        .step-icon{min-width:20px;}
        .form-section{display:none;background:var(--card);border:1px solid var(--border2);padding:36px;margin-bottom:32px;}
        .barcode-info{background:var(--bg);border:1px solid var(--green);padding:12px 18px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;}
        .barcode-label{color:var(--muted);font-size:.78em;font-family:'Space Mono',monospace;}
        .barcode-code{font-family:'Space Mono',monospace;font-size:1.05em;color:var(--green);letter-spacing:2px;}
        .product-found-banner{background:rgba(0,200,100,.06);border:1px solid var(--green);padding:14px 18px;margin-bottom:20px;display:none;}
        .product-found-banner h4{font-family:'Space Mono',monospace;font-size:.82em;color:var(--green);letter-spacing:1px;margin-bottom:3px;}
        .product-found-banner p{font-size:.82em;color:var(--muted);}
        .barcode-preview-box{text-align:center;margin-bottom:20px;padding:18px;background:var(--bg);border:1px solid var(--border);}
        .barcode-preview-box img{max-width:100%;max-height:240px;width:auto;height:auto;object-fit:contain;display:block;margin:0 auto;}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px;}
        .form-group{margin-bottom:20px;}
        .form-group.full-width{grid-column:1/-1;}
        label{display:block;font-family:'Space Mono',monospace;font-size:.75em;letter-spacing:1.5px;color:var(--muted);margin-bottom:7px;text-transform:uppercase;}
        input[type="text"],input[type="number"],input[type="password"],textarea,select{width:100%;padding:11px 14px;border:1px solid var(--border2);background:var(--input-bg);color:var(--text);font-size:.92em;font-family:'Inter',sans-serif;transition:border-color .2s;}
        select{cursor:pointer;}
        input:focus,textarea:focus,select:focus{outline:none;border-color:var(--green);}
        input.auto-filled{border-color:rgba(0,200,100,.4);}
        textarea{resize:vertical;min-height:96px;}
        .rating-input{display:flex;align-items:center;gap:14px;}
        input[type="range"]{flex:1;height:4px;background:var(--border2);outline:none;border:none;-webkit-appearance:none;cursor:pointer;}
        input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;background:var(--text);cursor:pointer;border-radius:50%;}
        .rating-value{font-family:'Space Mono',monospace;font-size:1.5em;font-weight:700;min-width:64px;text-align:right;}
        .button-group{display:flex;gap:10px;margin-top:24px;}
        .button-group .btn{flex:1;}
        .store-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
        .store-chip{background:var(--bg2);border:1px solid var(--border);padding:6px 12px;font-size:.8em;font-family:'Space Mono',monospace;display:flex;align-items:center;gap:6px;}
        .store-chip.auto-filled{border-color:rgba(0,200,100,.4);}

        /* LOGIN REQUIRED */
        .login-required-banner{background:var(--bg2);border:1px solid var(--border2);padding:16px 20px;text-align:center;margin-top:16px;font-size:.9em;color:var(--muted);}
        .login-required-banner button{margin-top:10px;}

        /* PRODUCTS */
        .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:22px;}
        .product-card{background:var(--card);border:1px solid var(--border);cursor:pointer;transition:all .22s;position:relative;}
        .product-card:hover{border-color:var(--border2);transform:translateY(-3px);box-shadow:var(--shadow);}
        .product-image{width:100%;height:175px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;}
        .product-image img{width:100%;height:100%;object-fit:contain;padding:8px;}
        .product-barcode-badge{position:absolute;top:9px;right:9px;background:rgba(0,0,0,.7);border:1px solid var(--green);padding:2px 7px;font-size:.68em;font-family:'Space Mono',monospace;color:var(--green);}
        .api-badge{position:absolute;top:9px;left:9px;background:rgba(0,200,100,.12);border:1px solid var(--green);padding:2px 7px;font-size:.65em;font-family:'Space Mono',monospace;color:var(--green);}
        .product-content{padding:16px;}
        .product-name{font-family:'Bebas Neue',sans-serif;font-size:1.35em;letter-spacing:2px;margin-bottom:5px;}
        .product-brand{font-size:.78em;color:var(--muted);margin-bottom:10px;font-family:'Space Mono',monospace;}
        .product-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border);}
        .product-price{font-family:'Space Mono',monospace;font-size:1.05em;}
        .product-rating{font-family:'Space Mono',monospace;font-size:1.05em;color:var(--green);}
        .product-info{color:var(--muted);font-size:.83em;margin-bottom:12px;line-height:1.5;}
        .product-stats{display:flex;justify-content:space-between;color:var(--muted2);font-size:.76em;font-family:'Space Mono',monospace;}
        .admin-controls{display:none;padding:10px 16px;background:rgba(200,0,0,.05);border-top:1px solid rgba(200,0,0,.15);gap:7px;}
        .admin-controls.visible{display:flex;}
        .admin-controls .btn{flex:1;padding:5px 10px;font-size:.72em;}

        /* EMPTY STATE */
        .empty-state{text-align:center;padding:90px 20px;color:var(--muted2);}
        .empty-state-icon{font-size:3.8em;margin-bottom:18px;}
        .empty-state-text{font-family:'Bebas Neue',sans-serif;font-size:1.9em;letter-spacing:4px;margin-bottom:8px;color:var(--muted);}
        .empty-state-sub{font-size:.82em;font-family:'Space Mono',monospace;}

        /* MODAL */
        .modal{display:none;position:fixed;inset:0;background:var(--overlay);z-index:2000;overflow-y:auto;padding:20px;}
        .modal.active{display:flex;align-items:flex-start;justify-content:center;padding-top:36px;}
        .modal-content{background:var(--card);border:1px solid var(--border2);max-width:860px;width:100%;margin-bottom:36px;}
        .modal-header{padding:24px 28px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;}
        .modal-title-block h2{font-family:'Bebas Neue',sans-serif;font-size:1.9em;letter-spacing:3px;}
        .modal-brand{font-size:.82em;color:var(--muted);font-family:'Space Mono',monospace;margin-top:3px;}
        .close-btn{background:none;border:none;color:var(--text);font-size:1.7em;cursor:pointer;padding:0;line-height:1;transition:color .2s;}
        .close-btn:hover{color:var(--red);}
        .modal-body{padding:28px;}
        .barcode-info-row{background:var(--bg);border:1px solid var(--green);padding:11px 16px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;}
        .product-detail-image{width:100%;height:260px;background:var(--bg2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;margin-bottom:24px;padding:14px;overflow:hidden;}
        .product-detail-image img{max-width:100%;max-height:232px;width:auto;height:auto;object-fit:contain;display:block;}
        .detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
        .detail-item{background:var(--bg2);border:1px solid var(--border);padding:14px;text-align:center;}
        .detail-label{font-size:.72em;color:var(--muted);margin-bottom:5px;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:1px;}
        .detail-value{font-family:'Space Mono',monospace;font-size:1.35em;font-weight:700;}
        .product-api-data{background:var(--bg2);border:1px solid var(--border);padding:18px;margin-bottom:20px;}
        .api-data-title{font-family:'Space Mono',monospace;font-size:.72em;color:var(--green);letter-spacing:2px;margin-bottom:12px;}
        .api-tags{display:flex;flex-wrap:wrap;gap:7px;}
        .api-tag{background:var(--bg);border:1px solid var(--border);padding:3px 10px;font-size:.76em;color:var(--muted);font-family:'Space Mono',monospace;}

        /* REVIEWS */
        .reviews-section{margin-top:24px;}
        .review{background:var(--bg2);border:1px solid var(--border);padding:16px;margin-bottom:14px;}
        .review-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border);}
        .review-header-left{display:flex;align-items:center;gap:10px;}
        .review-author-chip{display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:.78em;}
        .review-avatar{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75em;font-weight:700;}
        .review-rating{font-family:'Space Mono',monospace;font-size:1.1em;color:var(--green);}
        .review-date{color:var(--muted2);font-size:.78em;font-family:'Space Mono',monospace;}
        .review-text{font-size:.88em;line-height:1.62;color:var(--text);opacity:.82;margin-bottom:12px;}
        .review-actions{display:flex;align-items:center;gap:8px;}
        .like-btn,.dislike-btn{display:flex;align-items:center;gap:5px;background:none;border:1px solid var(--border2);color:var(--muted);font-family:'Space Mono',monospace;font-size:.75em;padding:4px 10px;cursor:pointer;transition:all .18s;}
        .like-btn:hover{border-color:var(--green);color:var(--green);}
        .dislike-btn:hover{border-color:var(--red);color:var(--red);}
        .like-btn.active{border-color:var(--green);color:var(--green);background:rgba(0,200,100,.08);}
        .dislike-btn.active{border-color:var(--red);color:var(--red);background:rgba(200,0,0,.08);}
        .review-admin-controls{display:none;margin-left:auto;}
        .review-admin-controls.visible{display:flex;gap:6px;}
        .add-review-section{background:var(--bg2);border:1px solid var(--border2);padding:20px;margin-top:14px;display:none;}
        .add-review-section.active{display:block;}
        .edit-form{display:none;margin-bottom:24px;}
        .edit-form.active{display:block;}

        /* LOADING */
        .loading{display:inline-block;width:14px;height:14px;border:2px solid var(--border2);border-top:2px solid var(--green);border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:7px;}
        @keyframes spin{to{transform:rotate(360deg);}}

        /* TOAST */
        .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--card);border:1px solid var(--border2);padding:12px 24px;font-family:'Space Mono',monospace;font-size:.82em;z-index:9999;transition:transform .3s;pointer-events:none;box-shadow:var(--shadow);}
        .toast.show{transform:translateX(-50%) translateY(0);}

        @media(max-width:768px){
            .products-grid{grid-template-columns:1fr;}
            .form-grid{grid-template-columns:1fr;}
            .detail-grid{grid-template-columns:1fr;}
            .header-content{flex-direction:column;gap:12px;}
            .settings-panel{width:100%;margin-top:0;}
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="logo">PRODUKT<span>FORUM</span></div>
        <div class="header-right">
            <div class="admin-badge" id="adminBadge">ADMIN</div>
            <div class="user-chip" id="userChip" onclick="openSettings()">
                <div class="user-avatar" id="headerAvatar"></div>
                <span id="headerUsername"></span>
            </div>
            <button class="btn" onclick="showUploadSection()">+ <span data-lang-key="add_product">PRODUKT</span></button>
            <button class="btn" onclick="openSettings()" title="Einstellungen">âš™ <span data-lang-key="settings">EINSTELLUNGEN</span></button>
        </div>
    </div>
</header>

<!-- SETTINGS OVERLAY -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsIfOutside(event)">
    <div class="settings-panel">
        <div class="settings-header">
            <h2 data-lang-key="settings_title">EINSTELLUNGEN</h2>
            <button class="close-btn" onclick="closeSettings()">Ã—</button>
        </div>
        <div>
            <!-- DARSTELLUNG -->
            <div class="settings-section">
                <div class="settings-section-title" data-lang-key="appearance">DARSTELLUNG</div>
                <div class="toggle-row">
                    <span class="toggle-label" data-lang-key="light_mode">Hell-Modus</span>
                    <div class="toggle" id="themeToggle" onclick="toggleTheme()"></div>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label" data-lang-key="language">Sprache</span>
                    <select id="languageSelect" onchange="changeLanguage(this.value)" style="padding:6px 10px;font-size:.85em;">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
            <!-- GITHUB SYNC -->
            <div class="settings-section">
                <div class="settings-section-title" data-lang-key="github_sync">GITHUB SYNCHRONISATION</div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label data-lang-key="github_token">GITHUB TOKEN</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxx...">
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label data-lang-key="github_repo">REPOSITORY (user/repo)</label>
                    <input type="text" id="githubRepo" placeholder="username/produktforum-data">
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-green" style="flex:1;" onclick="saveGithubConfig()"><span data-lang-key="save">SPEICHERN</span></button>
                    <button class="btn" style="flex:1;" onclick="syncToGithub()"><span data-lang-key="sync_now">SYNC</span></button>
                </div>
                <div class="sync-status" id="syncStatus" style="display:none;">
                    <div class="sync-indicator"></div>
                    <span data-lang-key="last_sync">Letzte Sync:</span> <span id="lastSyncTime">â€”</span>
                </div>
            </div>
            <!-- ACCOUNT -->
            <div class="settings-section">
                <div class="settings-section-title" data-lang-key="account">ACCOUNT</div>
                <div class="account-loggedin" id="accountLoggedIn">
                    <div class="account-info-box">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                            <div class="user-avatar" id="settingsAvatar" style="width:36px;height:36px;font-size:1.1em;"></div>
                            <div style="flex:1;">
                                <div style="display:flex;align-items:center;">
                                    <div class="account-username" id="settingsUsername"></div>
                                    <div class="user-level" id="userLevel">LVL 1</div>
                                </div>
                                <div class="account-stats" id="settingsStats"></div>
                            </div>
                        </div>
                        <div class="user-badges" id="userBadges"></div>
                    </div>
                    <button class="btn btn-red" style="width:100%;" onclick="logout()"><span data-lang-key="logout">ABMELDEN</span></button>
                </div>
                <div class="account-loggedout" id="accountLoggedOut">
                    <div class="form-group" style="margin-bottom:12px;">
                        <label data-lang-key="username">BENUTZERNAME</label>
                        <input type="text" id="regUsername" placeholder="z.B. MaxMustermann" maxlength="20">
                    </div>
                    <div class="form-group" style="margin-bottom:12px;">
                        <label data-lang-key="email">EMAIL (Optional)</label>
                        <input type="text" id="regEmail" placeholder="max@beispiel.de">
                    </div>
                    <div class="form-group" style="margin-bottom:14px;">
                        <label data-lang-key="password">PASSWORT</label>
                        <input type="password" id="regPassword" placeholder="Mindestens 4 Zeichen">
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-solid" style="flex:1;" onclick="loginUser()"><span data-lang-key="login">ANMELDEN</span></button>
                        <button class="btn btn-green" style="flex:1;" onclick="registerUser()"><span data-lang-key="register">REGISTRIEREN</span></button>
                    </div>
                </div>
            </div>
            <!-- ADMIN -->
            <div class="settings-section">
                <div class="settings-section-title" data-lang-key="admin">ADMINISTRATION</div>
                <div class="admin-loggedin" id="adminLoggedIn">
                    <div class="admin-status-dot"></div>
                    <span style="font-size:.85em;font-family:'Space Mono',monospace;" data-lang-key="admin_active">Admin-Modus aktiv</span>
                    <button class="btn btn-sm btn-red" style="margin-left:auto;" onclick="adminLogout()"><span data-lang-key="logout">ABMELDEN</span></button>
                </div>
                <div id="adminLoggedOut">
                    <div class="form-group" style="margin-bottom:12px;">
                        <label data-lang-key="admin_password">ADMIN-PASSWORT</label>
                        <input type="password" id="adminPassword" placeholder="Passwort" onkeydown="if(event.key==='Enter')adminLogin()">
                    </div>
                    <button class="btn btn-solid" style="width:100%;" onclick="adminLogin()"><span data-lang-key="admin_login">ADMIN LOGIN</span></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Upload -->
    <div class="upload-section" id="uploadSection">
        <h2 class="section-title" data-lang-key="scan_barcode">BARCODE SCANNEN</h2>
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“·</div>
            <div class="upload-text" data-lang-key="upload_barcode">Barcode-Bild hochladen</div>
            <div class="upload-subtext" data-lang-key="auto_detect">Produktdaten werden automatisch erkannt</div>
            <input type="file" id="fileInput" accept="image/*">
        </div>
    </div>
    <!-- Scanner -->
    <div class="scanner-container" id="scannerContainer">
        <h2 class="section-title" data-lang-key="analyzing">BARCODE WIRD ANALYSIERT</h2>
        <div id="barcode-scanner"></div>
        <div class="scanner-status" id="scannerStatus"><div class="loading"></div> <span data-lang-key="scanning">Bild wird gescannt...</span></div>
        <div id="barcodeResult"></div>
        <div class="lookup-status" id="lookupStatus">
            <div class="lookup-step" id="step-scan"><span class="step-icon">â¬œ</span><span data-lang-key="step_scan">Barcode scannen</span></div>
            <div class="lookup-step" id="step-lookup"><span class="step-icon">â¬œ</span><span data-lang-key="step_lookup">Produktdaten abrufen (Open Food Facts)</span></div>
            <div class="lookup-step" id="step-price"><span class="step-icon">â¬œ</span><span data-lang-key="step_price">Preisdaten abrufen</span></div>
            <div class="lookup-step" id="step-fill"><span class="step-icon">â¬œ</span><span data-lang-key="step_fill">Formular automatisch befÃ¼llen</span></div>
        </div>
        <div class="button-group" style="margin-top:18px;"><button class="btn" onclick="cancelScan()"><span data-lang-key="cancel">Abbrechen</span></button></div>
    </div>
    <!-- Product Form -->
    <div class="form-section" id="productForm">
        <h2 class="section-title" data-lang-key="add_product_title">PRODUKT HINZUFÃœGEN</h2>
        <div class="barcode-info">
            <div><div class="barcode-label" data-lang-key="detected_barcode">ERKANNTER BARCODE</div><div class="barcode-code" id="detectedBarcode"></div></div>
            <div id="barcodeSourceBadge"></div>
        </div>
        <div class="product-found-banner" id="productFoundBanner">
            <h4>âœ“ <span data-lang-key="product_auto_detected">PRODUKT AUTOMATISCH ERKANNT</span></h4>
            <p id="productFoundText"></p>
        </div>
        <div class="barcode-preview-box"><img id="barcodePreview" alt="Barcode"></div>
        <div class="form-grid">
            <div class="form-group"><label data-lang-key="product_name">Produktname *</label><input type="text" id="productName" placeholder="z.B. Milka Schokolade"></div>
            <div class="form-group"><label data-lang-key="brand">Marke</label><input type="text" id="productBrand" placeholder="z.B. Milka"></div>
            <div class="form-group"><label data-lang-key="price">Preis (â‚¬) *</label><input type="number" id="productPrice" step="0.01" placeholder="2.99"></div>
            <div class="form-group"><label data-lang-key="category">Kategorie</label><input type="text" id="productCategory" placeholder="z.B. SÃ¼ÃŸwaren"></div>
            <div class="form-group full-width">
                <label data-lang-key="stores">VerfÃ¼gbar in Filialen</label>
                <div id="storesContainer" class="store-list">
                    <div class="store-chip">
                        <input type="checkbox" id="store_rewe" value="REWE">
                        <label for="store_rewe" style="margin:0;cursor:pointer;">REWE</label>
                    </div>
                    <div class="store-chip">
                        <input type="checkbox" id="store_edeka" value="EDEKA">
                        <label for="store_edeka" style="margin:0;cursor:pointer;">EDEKA</label>
                    </div>
                    <div class="store-chip">
                        <input type="checkbox" id="store_aldi" value="ALDI">
                        <label for="store_aldi" style="margin:0;cursor:pointer;">ALDI</label>
                    </div>
                    <div class="store-chip">
                        <input type="checkbox" id="store_lidl" value="LIDL">
                        <label for="store_lidl" style="margin:0;cursor:pointer;">LIDL</label>
                    </div>
                    <div class="store-chip">
                        <input type="checkbox" id="store_kaufland" value="KAUFLAND">
                        <label for="store_kaufland" style="margin:0;cursor:pointer;">KAUFLAND</label>
                    </div>
                    <div class="store-chip">
                        <input type="checkbox" id="store_penny" value="PENNY">
                        <label for="store_penny" style="margin:0;cursor:pointer;">PENNY</label>
                    </div>
                </div>
            </div>
            <div class="form-group full-width"><label data-lang-key="product_info">Produktinformationen</label><textarea id="productInfo" placeholder="Beschreibung, Inhaltsstoffe..."></textarea></div>
            <div class="form-group full-width"><label data-lang-key="your_review">Deine Bewertung *</label><textarea id="reviewText" placeholder="Was hÃ¤ltst du von diesem Produkt?"></textarea></div>
            <div class="form-group full-width">
                <label data-lang-key="rating">Bewertung (%)</label>
                <div class="rating-input">
                    <input type="range" id="ratingSlider" min="0" max="100" value="75">
                    <span class="rating-value" id="ratingValue">75%</span>
                </div>
            </div>
        </div>
        <div class="button-group">
            <button class="btn" onclick="cancelUpload()"><span data-lang-key="cancel">Abbrechen</span></button>
            <button class="btn btn-solid" onclick="saveProduct()"><span data-lang-key="save_product">Produkt Speichern</span></button>
        </div>
    </div>
    <!-- Products -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;">
        <div class="section-title" style="border:none;padding:0;margin:0;" data-lang-key="all_products">ALLE PRODUKTE</div>
    </div>
    <div class="products-grid" id="productsGrid"></div>
    <div class="empty-state" id="emptyState">
        <div class="empty-state-icon">ðŸ“¦</div>
        <div class="empty-state-text" data-lang-key="no_products">Noch keine Produkte</div>
        <div class="empty-state-sub" data-lang-key="scan_first">Scanne dein erstes Produkt!</div>
    </div>
</div>

<!-- PRODUCT MODAL -->
<div class="modal" id="productModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title-block">
                <h2 id="modalTitle"></h2>
                <div class="modal-brand" id="modalBrand"></div>
            </div>
            <button class="close-btn" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="barcode-info-row">
                <div><div class="barcode-label">BARCODE</div><div class="barcode-code" id="modalBarcode"></div></div>
                <div id="modalApiSource" style="font-size:.72em;font-family:'Space Mono',monospace;color:var(--green);"></div>
            </div>
            <div class="product-detail-image"><img id="modalBarcodeImage" alt="Produktbild"></div>
            <div class="detail-grid">
                <div class="detail-item"><div class="detail-label" data-lang-key="price">Preis</div><div class="detail-value" id="modalPrice"></div></div>
                <div class="detail-item"><div class="detail-label" data-lang-key="avg_rating">Ã˜ Bewertung</div><div class="detail-value" id="modalRating" style="color:var(--green);"></div></div>
                <div class="detail-item"><div class="detail-label" data-lang-key="reviews">Bewertungen</div><div class="detail-value" id="modalReviewCount"></div></div>
            </div>
            <div class="form-group" style="margin-bottom:18px;"><label data-lang-key="category">Kategorie</label><div id="modalCategory" style="color:var(--muted);font-size:.88em;"></div></div>
            <div class="form-group" style="margin-bottom:18px;"><label data-lang-key="stores">VerfÃ¼gbar in</label><div id="modalStores" class="store-list"></div></div>
            <div id="modalApiDataSection" class="product-api-data" style="display:none;">
                <div class="api-data-title">â—ˆ PRODUKTDATEN (OPEN FOOD FACTS)</div>
                <div class="api-tags" id="modalApiTags"></div>
            </div>
            <div class="form-group"><label data-lang-key="product_info">Produktinformationen</label><div id="modalInfo" style="color:var(--muted);line-height:1.62;font-size:.88em;"></div></div>
            <div class="edit-form" id="editForm">
                <h3 class="section-title" style="font-size:1.15em;" data-lang-key="edit_product">PRODUKT BEARBEITEN</h3>
                <div class="form-grid">
                    <div class="form-group"><label data-lang-key="product_name">Produktname</label><input type="text" id="editProductName"></div>
                    <div class="form-group"><label data-lang-key="brand">Marke</label><input type="text" id="editProductBrand"></div>
                    <div class="form-group"><label data-lang-key="price">Preis (â‚¬)</label><input type="number" id="editProductPrice" step="0.01"></div>
                    <div class="form-group"><label data-lang-key="category">Kategorie</label><input type="text" id="editProductCategory"></div>
                    <div class="form-group full-width"><label data-lang-key="product_info">Produktinformationen</label><textarea id="editProductInfo"></textarea></div>
                </div>
                <div class="button-group">
                    <button class="btn" onclick="cancelEdit()"><span data-lang-key="cancel">Abbrechen</span></button>
                    <button class="btn btn-solid" onclick="saveEdit()"><span data-lang-key="save">Speichern</span></button>
                </div>
            </div>
            <div class="reviews-section">
                <h3 class="section-title" style="font-size:1.15em;" data-lang-key="reviews">BEWERTUNGEN</h3>
                <div id="modalReviews"></div>
                <div id="addReviewArea" style="margin-top:14px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============= TRANSLATIONS =============
const translations = {
    de: {
        add_product: 'PRODUKT',
        settings: 'EINSTELLUNGEN',
        settings_title: 'EINSTELLUNGEN',
        appearance: 'DARSTELLUNG',
        light_mode: 'Hell-Modus',
        language: 'Sprache',
        github_sync: 'GITHUB SYNCHRONISATION',
        github_token: 'GITHUB TOKEN',
        github_repo: 'REPOSITORY (user/repo)',
        save: 'SPEICHERN',
        sync_now: 'SYNC',
        last_sync: 'Letzte Sync:',
        account: 'ACCOUNT',
        username: 'BENUTZERNAME',
        email: 'EMAIL (Optional)',
        password: 'PASSWORT',
        login: 'ANMELDEN',
        register: 'REGISTRIEREN',
        logout: 'ABMELDEN',
        admin: 'ADMINISTRATION',
        admin_active: 'Admin-Modus aktiv',
        admin_password: 'ADMIN-PASSWORT',
        admin_login: 'ADMIN LOGIN',
        scan_barcode: 'BARCODE SCANNEN',
        upload_barcode: 'Barcode-Bild hochladen',
        auto_detect: 'Produktdaten werden automatisch erkannt',
        analyzing: 'BARCODE WIRD ANALYSIERT',
        scanning: 'Bild wird gescannt...',
        step_scan: 'Barcode scannen',
        step_lookup: 'Produktdaten abrufen (Open Food Facts)',
        step_price: 'Preisdaten abrufen',
        step_fill: 'Formular automatisch befÃ¼llen',
        cancel: 'Abbrechen',
        add_product_title: 'PRODUKT HINZUFÃœGEN',
        detected_barcode: 'ERKANNTER BARCODE',
        product_auto_detected: 'PRODUKT AUTOMATISCH ERKANNT',
        product_name: 'Produktname *',
        brand: 'Marke',
        price: 'Preis (â‚¬) *',
        category: 'Kategorie',
        stores: 'VerfÃ¼gbar in Filialen',
        product_info: 'Produktinformationen',
        your_review: 'Deine Bewertung *',
        rating: 'Bewertung (%)',
        save_product: 'Produkt Speichern',
        all_products: 'ALLE PRODUKTE',
        no_products: 'Noch keine Produkte',
        scan_first: 'Scanne dein erstes Produkt!',
        avg_rating: 'Ã˜ Bewertung',
        reviews: 'Bewertungen',
        edit_product: 'PRODUKT BEARBEITEN'
    },
    en: {
        add_product: 'PRODUCT',
        settings: 'SETTINGS',
        settings_title: 'SETTINGS',
        appearance: 'APPEARANCE',
        light_mode: 'Light Mode',
        language: 'Language',
        github_sync: 'GITHUB SYNCHRONIZATION',
        github_token: 'GITHUB TOKEN',
        github_repo: 'REPOSITORY (user/repo)',
        save: 'SAVE',
        sync_now: 'SYNC',
        last_sync: 'Last Sync:',
        account: 'ACCOUNT',
        username: 'USERNAME',
        email: 'EMAIL (Optional)',
        password: 'PASSWORD',
        login: 'LOGIN',
        register: 'REGISTER',
        logout: 'LOGOUT',
        admin: 'ADMINISTRATION',
        admin_active: 'Admin mode active',
        admin_password: 'ADMIN PASSWORD',
        admin_login: 'ADMIN LOGIN',
        scan_barcode: 'SCAN BARCODE',
        upload_barcode: 'Upload Barcode Image',
        auto_detect: 'Product data will be detected automatically',
        analyzing: 'ANALYZING BARCODE',
        scanning: 'Scanning image...',
        step_scan: 'Scan barcode',
        step_lookup: 'Fetch product data (Open Food Facts)',
        step_price: 'Fetch price data',
        step_fill: 'Auto-fill form',
        cancel: 'Cancel',
        add_product_title: 'ADD PRODUCT',
        detected_barcode: 'DETECTED BARCODE',
        product_auto_detected: 'PRODUCT AUTO-DETECTED',
        product_name: 'Product Name *',
        brand: 'Brand',
        price: 'Price (â‚¬) *',
        category: 'Category',
        stores: 'Available in Stores',
        product_info: 'Product Information',
        your_review: 'Your Review *',
        rating: 'Rating (%)',
        save_product: 'Save Product',
        all_products: 'ALL PRODUCTS',
        no_products: 'No products yet',
        scan_first: 'Scan your first product!',
        avg_rating: 'Avg. Rating',
        reviews: 'Reviews',
        edit_product: 'EDIT PRODUCT'
    }
};

let currentLang = 'de';

function changeLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('pf_language', lang);
    document.documentElement.lang = lang;
    
    // Update all elements with data-lang-key
    document.querySelectorAll('[data-lang-key]').forEach(el => {
        const key = el.getAttribute('data-lang-key');
        if (translations[lang][key]) {
            el.textContent = translations[lang][key];
        }
    });
    
    showToast(lang === 'de' ? 'Sprache geÃ¤ndert zu Deutsch' : 'Language changed to English');
}

// ============= CORE VARIABLES =============
const STORAGE_KEY='pf_products_v3',USERS_KEY='pf_users_v2',SESSION_KEY='pf_session_v1',VOTES_KEY='pf_votes_v1',ADMIN_PW='Admin404',GITHUB_KEY='pf_github_config';
let isAdmin=false,currentUser=null,currentProduct=null,currentBarcodeImage=null,currentBarcode=null,isScanning=false,currentApiData=null,githubConfig=null;

document.addEventListener('DOMContentLoaded',()=>{
    loadSession();
    loadGithubConfig();
    const savedLang = localStorage.getItem('pf_language') || 'de';
    document.getElementById('languageSelect').value = savedLang;
    changeLanguage(savedLang);
    applyTheme(localStorage.getItem('pf_theme')||'dark');
    setupEventListeners();
    displayProducts();
});

function setupEventListeners(){
    const ua=document.getElementById('uploadArea'),fi=document.getElementById('fileInput');
    ua.addEventListener('click',()=>fi.click());
    ua.addEventListener('dragover',e=>{e.preventDefault();ua.classList.add('dragover');});
    ua.addEventListener('dragleave',()=>ua.classList.remove('dragover'));
    ua.addEventListener('drop',e=>{e.preventDefault();ua.classList.remove('dragover');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))handleImageUpload(f);});
    fi.addEventListener('change',e=>{if(e.target.files[0])handleImageUpload(e.target.files[0]);});
    document.getElementById('ratingSlider').addEventListener('input',e=>document.getElementById('ratingValue').textContent=e.target.value+'%');
    document.getElementById('productModal').addEventListener('click',e=>{if(e.target.id==='productModal')closeModal();});
}

/* THEME */
function applyTheme(t){
    document.documentElement.setAttribute('data-theme',t);
    localStorage.setItem('pf_theme',t);
    document.getElementById('themeToggle').classList.toggle('on',t==='light');
}
function toggleTheme(){applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');}

/* GITHUB INTEGRATION */
function loadGithubConfig(){
    try{
        const cfg = JSON.parse(localStorage.getItem(GITHUB_KEY));
        if(cfg && cfg.token && cfg.repo) {
            githubConfig = cfg;
            document.getElementById('githubToken').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            document.getElementById('githubRepo').value = cfg.repo;
            if(cfg.lastSync) {
                document.getElementById('syncStatus').style.display = 'flex';
                document.getElementById('lastSyncTime').textContent = fmtDate(cfg.lastSync);
            }
        }
    }catch{}
}

function saveGithubConfig(){
    const token = document.getElementById('githubToken').value.trim();
    const repo = document.getElementById('githubRepo').value.trim();
    
    if(!token || token === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
        if(githubConfig && githubConfig.token) {
            // Keep existing token
        } else {
            showToast('Bitte GitHub Token eingeben');
            return;
        }
    } else {
        githubConfig = githubConfig || {};
        githubConfig.token = token;
    }
    
    if(!repo || !repo.includes('/')) {
        showToast('Bitte gÃ¼ltiges Repository eingeben (user/repo)');
        return;
    }
    
    githubConfig.repo = repo;
    localStorage.setItem(GITHUB_KEY, JSON.stringify(githubConfig));
    document.getElementById('githubToken').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
    showToast('GitHub-Konfiguration gespeichert âœ“');
}

async function syncToGithub(){
    if(!githubConfig || !githubConfig.token || !githubConfig.repo) {
        showToast('Bitte erst GitHub-Konfiguration speichern');
        return;
    }
    
    showToast('Synchronisiere mit GitHub...');
    
    try {
        const products = getProducts();
        const users = getUsers();
        const votes = getVotes();
        
        const data = {
            products,
            users,
            votes,
            syncedAt: new Date().toISOString()
        };
        
        const [owner, repo] = githubConfig.repo.split('/');
        const path = 'data/produktforum-data.json';
        
        // Get current file SHA if exists
        let sha = null;
        try {
            const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            if(getRes.ok) {
                const fileData = await getRes.json();
                sha = fileData.sha;
            }
        } catch(e) {
            // File doesn't exist yet, that's ok
        }
        
        // Create or update file
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
        const payload = {
            message: `Update ProduktForum data - ${new Date().toISOString()}`,
            content,
            sha
        };
        
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubConfig.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(payload)
        });
        
        if(res.ok) {
            githubConfig.lastSync = new Date().toISOString();
            localStorage.setItem(GITHUB_KEY, JSON.stringify(githubConfig));
            document.getElementById('syncStatus').style.display = 'flex';
            document.getElementById('lastSyncTime').textContent = fmtDate(githubConfig.lastSync);
            showToast('âœ“ Erfolgreich mit GitHub synchronisiert!');
        } else {
            const error = await res.json();
            console.error('GitHub sync error:', error);
            showToast('âŒ GitHub Sync fehlgeschlagen');
        }
    } catch(error) {
        console.error('Sync error:', error);
        showToast('âŒ Fehler bei der Synchronisation');
    }
}

/* SETTINGS */
function openSettings(){document.getElementById('settingsOverlay').classList.add('active');updateSettingsUI();}
function closeSettings(){document.getElementById('settingsOverlay').classList.remove('active');}
function closeSettingsIfOutside(e){if(e.target.id==='settingsOverlay')closeSettings();}
function updateSettingsUI(){
    const li=document.getElementById('accountLoggedIn'),lo=document.getElementById('accountLoggedOut');
    if(currentUser){
        li.classList.add('active');lo.classList.add('hidden');
        document.getElementById('settingsUsername').textContent=currentUser.username;
        const av=document.getElementById('settingsAvatar');
        av.textContent=currentUser.username[0].toUpperCase();
        av.style.background=currentUser.color;av.style.color='#000';
        const products=getProducts();
        const rc=products.reduce((s,p)=>s+p.reviews.filter(r=>r.author===currentUser.username).length,0);
        const xp = currentUser.xp || 0;
        const level = Math.floor(xp / 100) + 1;
        document.getElementById('userLevel').textContent = 'LVL ' + level;
        document.getElementById('settingsStats').textContent=rc+' Bewertung(en) Â· '+xp+' XP';
        
        // Badges
        const badges = [];
        if(rc >= 1) badges.push('ðŸŒŸ Erstes Review');
        if(rc >= 5) badges.push('ðŸ“ Reviewer');
        if(rc >= 10) badges.push('ðŸ† Pro Reviewer');
        if(products.filter(p => p.reviews.some(r => r.author === currentUser.username)).length >= 3) badges.push('ðŸ” Scout');
        
        const badgesEl = document.getElementById('userBadges');
        badgesEl.innerHTML = badges.map(b => `<div class="badge">${b}</div>`).join('');
    } else {
        li.classList.remove('active');lo.classList.remove('hidden');
    }
    document.getElementById('adminLoggedIn').classList.toggle('active',isAdmin);
    document.getElementById('adminLoggedOut').style.display=isAdmin?'none':'block';
}

/* ACCOUNT */
function getUsers(){try{return JSON.parse(localStorage.getItem(USERS_KEY)||'{}')}catch{return {};}}
function saveUsers(u){localStorage.setItem(USERS_KEY,JSON.stringify(u));}
function loadSession(){try{const s=JSON.parse(localStorage.getItem(SESSION_KEY));if(s&&s.username){currentUser=s;updateHeaderUser();}}catch{}}
function saveSession(u){localStorage.setItem(SESSION_KEY,JSON.stringify(u));}
const COLORS=['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c','#e67e22','#00cec9'];
function randomColor(){return COLORS[Math.floor(Math.random()*COLORS.length)];}

function registerUser(){
    const uname=document.getElementById('regUsername').value.trim();
    const email=document.getElementById('regEmail').value.trim();
    const pw=document.getElementById('regPassword').value;
    if(!uname||uname.length<2){showToast('Name muss mind. 2 Zeichen haben');return;}
    if(!pw||pw.length<4){showToast('Passwort muss mind. 4 Zeichen haben');return;}
    const users=getUsers();
    if(users[uname]){showToast('Benutzername bereits vergeben!');return;}
    users[uname]={pw,email,color:randomColor(),xp:0,joined:new Date().toISOString()};
    saveUsers(users);
    currentUser={username:uname,color:users[uname].color,xp:0};
    saveSession(currentUser);updateHeaderUser();updateSettingsUI();
    showToast('Willkommen, '+uname+'! ðŸ‘‹');
    syncToGithub();
}
function loginUser(){
    const uname=document.getElementById('regUsername').value.trim();
    const pw=document.getElementById('regPassword').value;
    const users=getUsers();
    if(!users[uname]){showToast('Benutzer nicht gefunden');return;}
    if(users[uname].pw!==pw){showToast('Falsches Passwort');return;}
    currentUser={username:uname,color:users[uname].color,xp:users[uname].xp||0};
    saveSession(currentUser);updateHeaderUser();updateSettingsUI();
    showToast('Willkommen zurÃ¼ck, '+uname+'! ðŸ‘‹');
}
function logout(){
    currentUser=null;localStorage.removeItem(SESSION_KEY);
    updateHeaderUser();updateSettingsUI();displayProducts();
    if(currentProduct)showProductDetail(currentProduct);
    showToast('Abgemeldet');
}
function updateHeaderUser(){
    const chip=document.getElementById('userChip');
    if(currentUser){
        chip.classList.add('active');
        document.getElementById('headerUsername').textContent=currentUser.username;
        const av=document.getElementById('headerAvatar');
        av.textContent=currentUser.username[0].toUpperCase();
        av.style.background=currentUser.color;av.style.color='#000';
    } else {chip.classList.remove('active');}
}

function addXP(amount) {
    if(!currentUser) return;
    const users = getUsers();
    if(users[currentUser.username]) {
        users[currentUser.username].xp = (users[currentUser.username].xp || 0) + amount;
        currentUser.xp = users[currentUser.username].xp;
        saveUsers(users);
        saveSession(currentUser);
        updateSettingsUI();
    }
}

/* ADMIN */
function adminLogin(){
    if(document.getElementById('adminPassword').value===ADMIN_PW){
        isAdmin=true;document.getElementById('adminBadge').classList.add('active');
        document.getElementById('adminPassword').value='';
        displayProducts();updateSettingsUI();showToast('Admin-Modus aktiviert ðŸ”');
    } else showToast('Falsches Admin-Passwort');
}
function adminLogout(){
    isAdmin=false;document.getElementById('adminBadge').classList.remove('active');
    displayProducts();updateSettingsUI();showToast('Admin-Modus deaktiviert');
}

/* VOTES */
function getVotes(){try{return JSON.parse(localStorage.getItem(VOTES_KEY)||'{}')}catch{return {};}}
function saveVotes(v){localStorage.setItem(VOTES_KEY,JSON.stringify(v));}
function voteReview(reviewId,voteType){
    if(!currentUser){showToast('Bitte erst anmelden, um zu voten');openSettings();return;}
    const votes=getVotes();
    const key=currentUser.username+'_'+reviewId;
    const prev=votes[key];
    if(prev===voteType)delete votes[key];else votes[key]=voteType;
    saveVotes(votes);
    const products=getProducts();
    const pidx=products.findIndex(p=>p.id===currentProduct.id);
    if(pidx!==-1){
        const ridx=products[pidx].reviews.findIndex(r=>r.id===reviewId);
        if(ridx!==-1){
            const rv=products[pidx].reviews[ridx];
            rv.likes=Object.entries(votes).filter(([k,v])=>k.endsWith('_'+reviewId)&&v==='like').length;
            rv.dislikes=Object.entries(votes).filter(([k,v])=>k.endsWith('_'+reviewId)&&v==='dislike').length;
            saveProducts(products);showProductDetail(products[pidx]);
        }
    }
    syncToGithub();
}
function getUserVote(reviewId){
    if(!currentUser)return null;
    return getVotes()[currentUser.username+'_'+reviewId]||null;
}

/* DATA */
function getProducts(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return [];}}
function saveProducts(p){localStorage.setItem(STORAGE_KEY,JSON.stringify(p));}

/* SCAN */
function handleImageUpload(file){
    const reader=new FileReader();
    reader.onload=e=>{
        currentBarcodeImage=e.target.result;
        document.getElementById('uploadSection').style.display='none';
        document.getElementById('scannerContainer').style.display='block';
        scanBarcode(e.target.result);
    };
    reader.readAsDataURL(file);
}
function scanBarcode(imageDataUrl){
    if(isScanning)return;isScanning=true;setStep('scan','active');
    const img=new Image();
    img.onload=()=>{
        Quagga.decodeSingle({
            src:imageDataUrl,numOfWorkers:0,inputStream:{size:800},
            decoder:{readers:['ean_reader','ean_8_reader','code_128_reader','code_39_reader','upc_reader','upc_e_reader','i2of5_reader']},
            locate:true
        },result=>{
            isScanning=false;
            if(result&&result.codeResult){
                setStep('scan','done');currentBarcode=result.codeResult.code;
                document.getElementById('barcodeResult').innerHTML=`<div class="barcode-result"><div class="barcode-label">ERKANNTER BARCODE</div><div class="barcode-number">${currentBarcode}</div></div>`;
                document.getElementById('lookupStatus').style.display='block';
                lookupProduct(currentBarcode);
            } else {
                setStep('scan','error');
                document.getElementById('scannerStatus').innerHTML='<span style="color:var(--red)">âŒ Kein Barcode erkannt</span>';
                setTimeout(()=>{
                    if(confirm('Kein Barcode gefunden. Nochmal versuchen?'))cancelScan();
                    else{currentBarcode='MANUAL_'+Date.now();document.getElementById('lookupStatus').style.display='block';lookupProduct(currentBarcode);}
                },800);
            }
        });
    };
    img.src=imageDataUrl;
}
async function lookupProduct(barcode){
    setStep('lookup','active');currentApiData=null;
    if(barcode.startsWith('MANUAL_')){
        setStep('lookup','error');
        setStep('price','error');
        setStep('fill','done');
        showForm(null);
        return;
    }
    try{
        const res=await fetch('https://world.openfoodfacts.org/api/v2/product/'+barcode+'.json');
        const data=await res.json();
        if(data.status===1&&data.product){
            setStep('lookup','done');
            currentApiData=data.product;
            
            // Fetch price data
            setStep('price','active');
            await fetchPriceData(barcode, data.product);
            
            const existing=getProducts().find(p=>p.barcode===barcode);
            if(existing){
                document.getElementById('scannerContainer').style.display='none';
                showProductDetail(existing);
                return;
            }
            setTimeout(()=>{
                setStep('fill','done');
                document.getElementById('scannerContainer').style.display='none';
                showForm(data.product);
            },600);
        } else {
            setStep('lookup','error');
            setStep('price','error');
            const existing=getProducts().find(p=>p.barcode===barcode);
            if(existing){
                document.getElementById('scannerContainer').style.display='none';
                showProductDetail(existing);
                return;
            }
            setStep('fill','done');
            setTimeout(()=>{
                document.getElementById('scannerContainer').style.display='none';
                showForm(null);
            },500);
        }
    }catch{
        setStep('lookup','error');
        setStep('price','error');
        const existing=getProducts().find(p=>p.barcode===barcode);
        if(existing){
            document.getElementById('scannerContainer').style.display='none';
            showProductDetail(existing);
            return;
        }
        setStep('fill','done');
        setTimeout(()=>{
            document.getElementById('scannerContainer').style.display='none';
            showForm(null);
        },500);
    }
}

async function fetchPriceData(barcode, productData) {
    try {
        // Try to get price from Open Food Facts stores data
        if(productData.stores_tags && productData.stores_tags.length > 0) {
            setStep('price','done');
            
            // Auto-select stores
            const storeMap = {
                'rewe': 'store_rewe',
                'edeka': 'store_edeka',
                'aldi': 'store_aldi',
                'lidl': 'store_lidl',
                'kaufland': 'store_kaufland',
                'penny': 'store_penny'
            };
            
            productData.stores_tags.forEach(store => {
                const storeLower = store.toLowerCase().replace('en:', '');
                if(storeMap[storeLower]) {
                    const checkbox = document.getElementById(storeMap[storeLower]);
                    if(checkbox) {
                        checkbox.checked = true;
                        checkbox.parentElement.classList.add('auto-filled');
                    }
                }
            });
            
            return;
        }
        
        // Fallback: simulate price lookup based on category
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Estimate price based on product data
        let estimatedPrice = 2.99; // Default
        
        const categories = productData.categories_tags || [];
        if(categories.some(c => c.includes('chocolate') || c.includes('snack'))) estimatedPrice = 1.99;
        if(categories.some(c => c.includes('beverage') || c.includes('drink'))) estimatedPrice = 1.49;
        if(categories.some(c => c.includes('milk') || c.includes('dairy'))) estimatedPrice = 0.99;
        
        setStep('price','done');
        return estimatedPrice;
        
    } catch(e) {
        setStep('price','error');
        return null;
    }
}

function setStep(step,state){
    const el=document.getElementById('step-'+step);if(!el)return;
    el.className='lookup-step '+state;
    el.querySelector('.step-icon').textContent={active:'âŸ³',done:'âœ“',error:'âœ—'}[state]||'â¬œ';
}
async function fetchImageAsBase64(url){
    try{const r=await fetch(url);if(!r.ok)return null;const blob=await r.blob();return new Promise((res,rej)=>{const rd=new FileReader();rd.onload=()=>res(rd.result);rd.onerror=()=>rej(null);rd.readAsDataURL(blob);});}catch{return null;}
}
async function showForm(product){
    document.getElementById('detectedBarcode').textContent=currentBarcode;
    document.getElementById('barcodePreview').src=currentBarcodeImage;
    if(product){
        const name=product.product_name_de||product.product_name||product.product_name_en||'';
        const brand=product.brands||'';
        const cat=product.categories_tags?.[0]?.replace('en:','').replace(/-/g,' ')||'';
        
        // Get estimated price
        const estimatedPrice = await fetchPriceData(currentBarcode, product);
        
        let dp=[];
        if(product.quantity)dp.push('Menge: '+product.quantity);
        const ing=product.ingredients_text_de||product.ingredients_text;
        if(ing)dp.push('Zutaten: '+ing.substring(0,300)+(ing.length>300?'...':''));
        if(product.nutriscore_grade)dp.push('Nutri-Score: '+product.nutriscore_grade.toUpperCase());
        if(product.packaging)dp.push('Verpackung: '+product.packaging);
        if(product.countries)dp.push('Herkunft: '+product.countries);
        
        setAutoField('productName',name);
        setAutoField('productBrand',brand);
        setAutoField('productCategory',cat);
        setAutoField('productInfo',dp.join('\n\n'));
        
        if(estimatedPrice) {
            setAutoField('productPrice', estimatedPrice);
        }
        
        const apiImg=product.image_front_small_url||product.image_front_url||product.image_url;
        if(apiImg){const b64=await fetchImageAsBase64(apiImg);if(b64){currentBarcodeImage=b64;document.getElementById('barcodePreview').src=b64;}}
        document.getElementById('productFoundBanner').style.display='block';
        document.getElementById('productFoundText').textContent='Gefunden: "'+name+'"'+(brand?' von '+brand:'')+'. Felder wurden automatisch ausgefÃ¼llt.';
        document.getElementById('barcodeSourceBadge').innerHTML='<span style="font-size:.72em;font-family:Space Mono,monospace;color:var(--green);">â—ˆ OPEN FOOD FACTS</span>';
    } else {
        document.getElementById('productFoundBanner').style.display='none';
        document.getElementById('barcodeSourceBadge').innerHTML='<span style="font-size:.72em;font-family:Space Mono,monospace;color:var(--muted);">MANUELL</span>';
    }
    document.getElementById('productForm').style.display='block';
}
function setAutoField(id,val){const el=document.getElementById(id);if(!el||!val)return;el.value=val;el.classList.add('auto-filled');}

/* SAVE PRODUCT */
function saveProduct(){
    const name=document.getElementById('productName').value.trim();
    const price=document.getElementById('productPrice').value;
    const reviewText=document.getElementById('reviewText').value.trim();
    if(!name||!price||!reviewText){showToast('Bitte Name, Preis und Bewertungstext ausfÃ¼llen');return;}
    
    // Get selected stores
    const stores = [];
    ['rewe','edeka','aldi','lidl','kaufland','penny'].forEach(store => {
        if(document.getElementById('store_'+store)?.checked) {
            stores.push(store.toUpperCase());
        }
    });
    
    const products=getProducts();
    const newProduct={
        id:Date.now().toString(),
        barcode:currentBarcode,
        barcodeImage:currentBarcodeImage,
        name,
        brand:document.getElementById('productBrand').value.trim(),
        category:document.getElementById('productCategory').value.trim(),
        price:parseFloat(price),
        stores: stores,
        info:document.getElementById('productInfo').value.trim()||'Keine weiteren Informationen',
        fromApi:!!currentApiData,
        apiData:currentApiData?{
            nutriscore:currentApiData.nutriscore_grade,
            quantity:currentApiData.quantity,
            countries:currentApiData.countries,
            packaging:currentApiData.packaging,
            labels:currentApiData.labels_tags
        }:null,
        reviews:[{
            id:Date.now().toString(),
            text:reviewText,
            rating:parseInt(document.getElementById('ratingSlider').value),
            author:currentUser?currentUser.username:'Anonym',
            date:new Date().toISOString(),
            likes:0,
            dislikes:0
        }],
        createdAt:new Date().toISOString()
    };
    products.push(newProduct);
    saveProducts(products);
    
    // Add XP for creating product
    if(currentUser) addXP(50);
    
    resetForm();
    displayProducts();
    showProductDetail(newProduct);
    showToast('Produkt gespeichert âœ“');
    syncToGithub();
}

/* DISPLAY */
function displayProducts(){
    const products=getProducts();
    const grid=document.getElementById('productsGrid'),empty=document.getElementById('emptyState');
    if(!products.length){grid.style.display='none';empty.style.display='block';return;}
    grid.style.display='grid';empty.style.display='none';grid.innerHTML='';
    products.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).forEach(p=>{
        const avg=calcAvg(p.reviews);
        const card=document.createElement('div');card.className='product-card';
        card.innerHTML=`
            ${p.fromApi?'<div class="api-badge">â—ˆ API</div>':''}
            <div class="product-barcode-badge">${p.barcode}</div>
            <div class="product-image"><img src="${p.barcodeImage||''}" alt="${p.name}" onerror="this.outerHTML='<div style=\\'font-size:3em;opacity:.15;\\'>ðŸ“¦</div>'"></div>
            <div class="product-content">
                <div class="product-name">${p.name}</div>
                ${p.brand?'<div class="product-brand">'+p.brand+'</div>':''}
                <div class="product-meta"><div class="product-price">${p.price.toFixed(2)} â‚¬</div><div class="product-rating">${avg}%</div></div>
                <div class="product-info">${trunc(p.info,88)}</div>
                <div class="product-stats"><span>${p.reviews.length} Bewertung(en)</span><span>${fmtDate(p.createdAt)}</span></div>
            </div>
            <div class="admin-controls ${isAdmin?'visible':''}" id="ac-${p.id}">
                <button class="btn btn-red" onclick="deleteProduct('${p.id}',event)">LÃ¶schen</button>
                <button class="btn" onclick="editProduct('${p.id}',event)">Bearbeiten</button>
            </div>`;
        card.addEventListener('click',e=>{if(!e.target.closest('.admin-controls'))showProductDetail(p);});
        grid.appendChild(card);
    });
}

function showProductDetail(product){
    currentProduct=product;const avg=calcAvg(product.reviews);
    document.getElementById('modalTitle').textContent=product.name;
    document.getElementById('modalBrand').textContent=product.brand?'Von '+product.brand:'';
    document.getElementById('modalBarcode').textContent=product.barcode;
    const mImg=document.getElementById('modalBarcodeImage');
    mImg.src=product.barcodeImage||'';
    mImg.onerror=function(){this.style.display='none';this.parentElement.innerHTML+='<div style="font-size:4em;opacity:.12">ðŸ“¦</div>';};
    document.getElementById('modalPrice').textContent=product.price.toFixed(2)+' â‚¬';
    document.getElementById('modalRating').textContent=avg+'%';
    document.getElementById('modalReviewCount').textContent=product.reviews.length;
    document.getElementById('modalInfo').textContent=product.info;
    document.getElementById('modalCategory').textContent=product.category||'â€”';
    
    // Display stores
    const storesEl = document.getElementById('modalStores');
    if(product.stores && product.stores.length > 0) {
        storesEl.innerHTML = product.stores.map(s => `<div class="store-chip" style="cursor:default;">${s}</div>`).join('');
    } else {
        storesEl.innerHTML = '<span style="color:var(--muted);">Keine Filialen angegeben</span>';
    }
    
    document.getElementById('modalApiSource').textContent=product.fromApi?'â—ˆ OPEN FOOD FACTS':'';
    const apiSec=document.getElementById('modalApiDataSection');
    if(product.apiData){
        apiSec.style.display='block';const tags=[];
        if(product.apiData.nutriscore)tags.push('Nutri-Score: '+product.apiData.nutriscore.toUpperCase());
        if(product.apiData.quantity)tags.push('Menge: '+product.apiData.quantity);
        if(product.apiData.countries)tags.push('Herkunft: '+product.apiData.countries);
        if(product.apiData.packaging)tags.push('Verpackung: '+product.apiData.packaging);
        if(product.apiData.labels)product.apiData.labels.slice(0,4).forEach(l=>tags.push(l.replace('en:','').replace(/-/g,' ')));
        document.getElementById('modalApiTags').innerHTML=tags.map(t=>'<span class="api-tag">'+t+'</span>').join('');
    } else apiSec.style.display='none';
    displayReviews(product.reviews);
    renderAddReviewArea();
    document.getElementById('productModal').classList.add('active');
    document.body.style.overflow='hidden';
}

function displayReviews(reviews){
    const container=document.getElementById('modalReviews');container.innerHTML='';
    const users=getUsers();
    reviews.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(review=>{
        const uv=getUserVote(review.id);
        const ac=review.author&&users[review.author]?users[review.author].color:'#888';
        const div=document.createElement('div');div.className='review';
        div.innerHTML=`
            <div class="review-header">
                <div class="review-header-left">
                    <div class="review-author-chip">
                        <div class="review-avatar" style="background:${ac};color:#000;">${(review.author||'?')[0].toUpperCase()}</div>
                        <span>${review.author||'Anonym'}</span>
                    </div>
                    <span class="review-rating">${review.rating}%</span>
                </div>
                <span class="review-date">${fmtDate(review.date)}</span>
            </div>
            <div class="review-text">${review.text}</div>
            <div class="review-actions">
                <button class="like-btn ${uv==='like'?'active':''}" onclick="voteReview('${review.id}','like')">ðŸ‘ <span>${review.likes||0}</span></button>
                <button class="dislike-btn ${uv==='dislike'?'active':''}" onclick="voteReview('${review.id}','dislike')">ðŸ‘Ž <span>${review.dislikes||0}</span></button>
                <div class="review-admin-controls ${isAdmin?'visible':''}">
                    <button class="btn btn-sm btn-red" onclick="deleteReview('${review.id}')">LÃ¶schen</button>
                </div>
            </div>`;
        container.appendChild(div);
    });
}

function renderAddReviewArea(){
    const area=document.getElementById('addReviewArea');
    if(currentUser){
        area.innerHTML=`
            <button class="btn btn-green" style="width:100%;" onclick="toggleAddReview()">+ BEWERTUNG HINZUFÃœGEN</button>
            <div class="add-review-section" id="addReviewSection">
                <div class="form-group"><label>Deine Bewertung</label><textarea id="newReviewText" placeholder="Teile deine Erfahrung..."></textarea></div>
                <div class="form-group">
                    <label>Bewertung (%)</label>
                    <div class="rating-input">
                        <input type="range" id="newRatingSlider" min="0" max="100" value="75" oninput="document.getElementById('newRatingValue').textContent=this.value+'%'">
                        <span class="rating-value" id="newRatingValue">75%</span>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn" onclick="cancelNewReview()">Abbrechen</button>
                    <button class="btn btn-solid" onclick="submitNewReview()">Senden</button>
                </div>
            </div>`;
    } else {
        area.innerHTML=`
            <div class="login-required-banner">
                <div>Melde dich an, um eine Bewertung zu schreiben</div>
                <button class="btn btn-green" style="margin-top:10px;" onclick="openSettings()">ANMELDEN / REGISTRIEREN</button>
            </div>`;
    }
}

function toggleAddReview(){
    const s=document.getElementById('addReviewSection');if(s)s.classList.toggle('active');
}
function cancelNewReview(){
    const s=document.getElementById('addReviewSection');
    if(s){s.classList.remove('active');const t=s.querySelector('#newReviewText');if(t)t.value='';}
}
function submitNewReview(){
    if(!currentUser){showToast('Bitte erst anmelden!');openSettings();return;}
    const text=document.getElementById('newReviewText')?.value.trim();
    const rating=parseInt(document.getElementById('newRatingSlider')?.value||75);
    if(!text){showToast('Bitte eine Bewertung schreiben!');return;}
    const products=getProducts();
    const idx=products.findIndex(p=>p.id===currentProduct.id);
    if(idx!==-1){
        products[idx].reviews.push({
            id:Date.now().toString(),
            text,
            rating,
            author:currentUser.username,
            date:new Date().toISOString(),
            likes:0,
            dislikes:0
        });
        saveProducts(products);
        addXP(25); // XP for review
        displayProducts();
        showProductDetail(products[idx]);
        showToast('Bewertung gespeichert âœ“');
        syncToGithub();
    }
}

/* ADMIN CONTROLS */
function deleteProduct(id,e){
    e.stopPropagation();if(!isAdmin)return;
    if(confirm('Produkt wirklich lÃ¶schen?')){
        saveProducts(getProducts().filter(p=>p.id!==id));
        displayProducts();
        showToast('Produkt gelÃ¶scht');
        syncToGithub();
    }
}
function editProduct(id,e){
    e.stopPropagation();if(!isAdmin)return;
    const product=getProducts().find(p=>p.id===id);if(!product)return;
    currentProduct=product;showProductDetail(product);
    document.getElementById('editForm').classList.add('active');
    document.getElementById('editProductName').value=product.name;
    document.getElementById('editProductBrand').value=product.brand||'';
    document.getElementById('editProductPrice').value=product.price;
    document.getElementById('editProductCategory').value=product.category||'';
    document.getElementById('editProductInfo').value=product.info;
}
function cancelEdit(){document.getElementById('editForm').classList.remove('active');}
function saveEdit(){
    const name=document.getElementById('editProductName').value.trim();
    const price=document.getElementById('editProductPrice').value;
    if(!name||!price){showToast('Name und Preis sind Pflicht');return;}
    const products=getProducts();
    const idx=products.findIndex(p=>p.id===currentProduct.id);
    if(idx!==-1){
        products[idx].name=name;
        products[idx].brand=document.getElementById('editProductBrand').value.trim();
        products[idx].price=parseFloat(price);
        products[idx].category=document.getElementById('editProductCategory').value.trim();
        products[idx].info=document.getElementById('editProductInfo').value.trim();
        saveProducts(products);
        displayProducts();
        showProductDetail(products[idx]);
        document.getElementById('editForm').classList.remove('active');
        showToast('Ã„nderungen gespeichert');
        syncToGithub();
    }
}
function deleteReview(reviewId){
    if(!isAdmin)return;if(!confirm('Bewertung lÃ¶schen?'))return;
    const products=getProducts();const idx=products.findIndex(p=>p.id===currentProduct.id);
    if(idx!==-1){
        products[idx].reviews=products[idx].reviews.filter(r=>r.id!==reviewId);
        if(!products[idx].reviews.length){
            if(confirm('Letzte Bewertung gelÃ¶scht. Auch Produkt lÃ¶schen?')){
                products.splice(idx,1);
                saveProducts(products);
                displayProducts();
                closeModal();
                syncToGithub();
                return;
            }
        }
        saveProducts(products);
        displayProducts();
        showProductDetail(products[idx]);
        showToast('Bewertung gelÃ¶scht');
        syncToGithub();
    }
}

/* HELPERS */
function calcAvg(reviews){if(!reviews.length)return 0;return Math.round(reviews.reduce((s,r)=>s+r.rating,0)/reviews.length);}
function trunc(t,n){return t&&t.length>n?t.substring(0,n)+'...':(t||'');}
function fmtDate(s){return new Date(s).toLocaleDateString(currentLang === 'de' ? 'de-DE' : 'en-US',{year:'numeric',month:'short',day:'numeric'});}
function closeModal(){document.getElementById('productModal').classList.remove('active');document.getElementById('editForm').classList.remove('active');document.body.style.overflow='auto';}
function showUploadSection(){document.getElementById('uploadSection').style.display='block';window.scrollTo({top:0,behavior:'smooth'});}
function cancelUpload(){resetForm();}
function cancelScan(){
    isScanning=false;
    document.getElementById('scannerContainer').style.display='none';
    document.getElementById('uploadSection').style.display='none';
    document.getElementById('barcodeResult').innerHTML='';
    document.getElementById('lookupStatus').style.display='none';
    currentBarcode=null;
    currentBarcodeImage=null;
    currentApiData=null;
}
function resetForm(){
    ['uploadSection','productForm','scannerContainer'].forEach(id=>document.getElementById(id).style.display='none');
    ['productName','productBrand','productPrice','productCategory','productInfo','reviewText'].forEach(id=>{
        const el=document.getElementById(id);
        el.value='';
        el.classList.remove('auto-filled');
    });
    // Reset store checkboxes
    ['rewe','edeka','aldi','lidl','kaufland','penny'].forEach(store => {
        const checkbox = document.getElementById('store_'+store);
        if(checkbox) {
            checkbox.checked = false;
            checkbox.parentElement.classList.remove('auto-filled');
        }
    });
    document.getElementById('fileInput').value='';
    document.getElementById('ratingSlider').value=75;
    document.getElementById('ratingValue').textContent='75%';
    document.getElementById('barcodeResult').innerHTML='';
    document.getElementById('lookupStatus').style.display='none';
    document.getElementById('productFoundBanner').style.display='none';
    ['step-scan','step-lookup','step-price','step-fill'].forEach(id=>{
        const el=document.getElementById(id);
        if(el){
            el.className='lookup-step';
            el.querySelector('.step-icon').textContent='â¬œ';
        }
    });
    currentBarcode=null;
    currentBarcodeImage=null;
    currentApiData=null;
    isScanning=false;
}
let toastTimer;
function showToast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg;
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>t.classList.remove('show'),2800);
}
</script>
</body>
</html>
